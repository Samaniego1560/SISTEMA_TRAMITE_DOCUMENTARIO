<div class="p-4 bg-gray-100 w-full h-full">
    <!-- Título principal -->
    <div class="mb-4">
        <div class="flex justify-start items-center px-4 py-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800">RESULTADO DEL CUESTIONARIO S.R.Q</h2>
        </div>
    </div>
    <app-toast></app-toast>

    <div *ngIf="!showResultSRQ; else viewResultSRQ">
        <!-- Bloque de búsqueda -->
        <div class="bg-white shadow rounded-lg mb-4 p-4">
            <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
                <div class="flex gap-4">
                    <select formControlName="filterType"
                        class="block w-1/3 pl-3 pr-10 py-2 border border-gray-300 rounded-sm sm:text-sm">
                        <option value="">--Seleccione una opción--</option>
                        <option value="dni">DNI</option>
                        <option value="diagnostico">Diagnóstico</option>
                        <option value="estado_evaluacion">Estado</option>
                        <option value="todos">Todos</option>
                    </select>
                    <div class="relative w-2/3">
                        <input formControlName="filterValue" type="text" placeholder="Ingresa el valor ..."
                            class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-sm sm:text-sm" />
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <button type="submit" class="text-white px-4 py-2 rounded hover:bg-green-100 focus:outline-none"
                        style="background: #1ABB9C;">
                        Buscar
                    </button>
                </div>
            </form>
        </div>

        <div *ngIf="isLoading" class="flex justify-center items-center mt-20">
            <div class="flex flex-col items-center">
                <svg class="w-12 h-12 text-green-500 animate-spin" fill="none" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
                <p class="text-gray-500 mt-2 text-lg">Cargando...</p>
            </div>
        </div>

        <div *ngIf="students.length > 0 && !isLoading">
            <!-- Tabla de resultados -->
            <div class="bg-white shadow ">
                <div class="overflow-auto" style="height: 500px;">
                    <table class="divide-y divide-gray-200 overflow-x-scroll table-fixed w-full">
                        <thead class="bg-gray-200 text-center">
                            <tr>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    DNI
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Num. atenciones
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    TIPO PACIENTE
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Num. celular
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nombre y Apellidos
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Escuela
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Diagnostico
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado
                                </th>
                                <th scope="col"
                                    class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-xs">
                            <tr *ngFor="let student of students">
                                <td class="px-4 py-2 whitespace-wrap text-sm text-gray-900">{{ student.dni }}</td>
                                <td class="px-4 py-2 whitespace-wrap text-sm text-gray-900">{{student.numeroAtencion}}
                                </td>
                                <td class="px-4 py-2 whitespace-wrap text-sm text-gray-900">{{ student.tipoPaciente }}
                                </td>
                                <td class="px-4 py-2 whitespace-wrap text-sm text-gray-900">{{ student.numPhone }}</td>
                                <td class="px-4 py-2 whitespace-wrap text-sm text-gray-900 ">{{ student.fullName }}</td>
                                <td class="px-4 py-2 whitespace-wrap text-sm text-gray-500">{{ student.school }}</td>
                                <td class="px-4 py-2 whitespace-wrap">
                                    <span [ngClass]="{
        'bg-green-100 text-green-800': student.diagnostico === 'Estable',
        'bg-yellow-100 text-yellow-800': student.diagnostico === 'Moderado',
        'bg-red-100 text-red-800': student.diagnostico === 'Grave',
        'bg-gray-100 text-gray-800': student.diagnostico === 'No Aplica'
      }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                        {{ student.diagnostico }}
                                    </span>
                                </td>
                                <td class="px-4 py-2 whitespace-wrap">
                                    <span [ngClass]="{
        'bg-green-100 text-green-800': student.status === 'Aprobado',
        'bg-yellow-100 text-yellow-800': student.status === 'Pendiente',
        'bg-gray-200 text-gray-800': student.status === 'Observado',
        'bg-gray-100 text-gray-800': student.status === 'No Aplica'
      }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                        {{ student.status }}
                                    </span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    <button (click)="handleDowloaderSrq(student.id)" class="text-blue-500 hover:text-blue-600 focus:outline-none ml-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor" class="size-5">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                        </svg>
                                    </button>
                                    <button class="text-green-500 hover:text-green-600 ml-2 focus:outline-none"
                                        (click)="handleViewResultSRQ(student.id)">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor" class="size-5">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center px-4 py-3 bg-gray-50">
                    <div>
                        <span class="text-sm text-gray-500">Mostrando: {{ students.length }} registros</span>
                    </div>
                    <app-pagination 
                        [currentPage]="currentPage"
                        [totalPages]="totalPages"
                        (pageChange)="onPageChange($event)">
                    </app-pagination>
                    <!-- <div class="flex gap-1">
                        <button class="px-3 py-1 border rounded text-gray-700 hover:bg-gray-200">&#171;</button>
                        <button class="px-3 py-1 border rounded text-white bg-blue-500 hover:bg-blue-600">1</button>
                        <button class="px-3 py-1 border rounded text-gray-700 hover:bg-gray-200">&#187;</button>
                    </div> -->
                </div>
            </div>
        </div>

        <div *ngIf="students.length == 0 && !isLoading" class="flex flex-col items-center justify-center h-full mt-10">
            <p class="text-gray-600 text-lg font-medium">No hay resultados</p>
            <p class="text-gray-500 text-sm">Prueba utilizando diferentes filtros o búsquedas.</p>
        </div>


    </div>
    <ng-template #viewResultSRQ>
        <div class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
            <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
                <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                    <div
                        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <div class="">
                                <div class="">

                                    <!-- Información del estudiante -->
                                    <div class="p-2" style="background-color: #1075bc;">
                                        <h2 class="text-sm font-bold text-white">INFORMACIÓN DEL PARTICIPANTE</h2>
                                    </div>
                                    <div class="grid grid-cols-2 gap-y-2 gap-x-4 p-4 border">
                                        <!-- Fila 1 -->
                                        <div class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Apellidos y Nombres:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.fullName}}</span>
                                        </div>
                                        <div class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Fecha de Nacimiento:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.birthDate}}</span>
                                        </div>

                                        <!-- Fila 2 -->
                                        <div class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Edad:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.age}}</span>
                                        </div>
                                        <div *ngIf="infoStudent.tipoPaciente === 'Alumno'" class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Colegio de
                                                procedencia:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.previousSchool}}</span>
                                        </div>

                                        <!-- Fila 3 -->
                                        <div class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Lugar de nacimiento:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.birthPlace}}</span>
                                        </div>
                                        <div *ngIf="infoStudent.tipoPaciente === 'Alumno'" class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Modalidad de ingreso a la
                                                UNAS:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.entryMode}}</span>
                                        </div>

                                        <!-- Fila 4 -->
                                        <div class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Con quiénes vive
                                                actualmente:</span>
                                            <span
                                                class="text-gray-900 w-1/2">{{infoStudent.currentLivingSituation}}</span>
                                        </div>
                                        <div *ngIf="infoStudent.tipoPaciente === 'Alumno'" class="flex items-center text-sm border-b border-gray-300 pb-1">
                                            <span class="font-semibold text-gray-700 w-1/2">Año que ingresó a la
                                                universidad:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.universityEntryYear}}</span>
                                        </div>

                                        <!-- Fila 5 -->
                                        <div *ngIf="infoStudent.tipoPaciente === 'Alumno'" class="flex items-center text-sm">
                                            <span class="font-semibold text-gray-700 w-1/2">Ciclo Actual:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.currentSemester}}</span>
                                        </div>
                                        <div class="flex items-center text-sm">
                                            <span class="font-semibold text-gray-700 w-1/2">Fecha de evaluación:</span>
                                            <span class="text-gray-900 w-1/2">{{infoStudent.evaluationDate}}</span>
                                        </div>
                                    </div>

                                    <!-- SRQ Section -->
                                    <div class="p-2" style="background-color: #1075bc;">
                                        <h2 class="text-sm font-bold text-white">S.R.Q</h2>
                                    </div>
                                    <div *ngIf="isLoading" class="flex justify-center items-center ">
                                        <div class="flex flex-col items-center">
                                            <svg class="w-12 h-12 text-green-500 animate-spin" fill="none"
                                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z">
                                                </path>
                                            </svg>
                                            <p class="text-gray-500 mt-2 text-lg">Cargando...</p>
                                        </div>
                                    </div>
                                    <div *ngIf="!isLoading && respuestas.length > 0" class="overflow-auto h-48">
                                        <table class="table-auto w-full text-sm border-collapse border border-gray-300">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">#</th>
                                                    <th class="border border-gray-300 p-2 text-left">Pregunta</th>
                                                    <th class="border border-gray-300 p-2 text-center">SÍ</th>
                                                    <th class="border border-gray-300 p-2 text-center">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let pregunta of respuestas; let i = index">
                                                    <td class="border border-gray-300 p-2 text-center">{{ i + 1 }}</td>
                                                    <td class="border border-gray-300 p-2">{{ pregunta.texto }}</td>
                                                    <td class="border border-gray-300 p-2 text-center">
                                                        <span *ngIf="pregunta.respuesta === 'SI'"
                                                            class="text-green-500 text-lg">✔</span>
                                                    </td>
                                                    <td class="border border-gray-300 p-2 text-center">
                                                        <span *ngIf="pregunta.respuesta === 'NO'"
                                                            class="text-red-500 text-lg">✘</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>

                                    </div>
                                    <div *ngIf="!isLoading && respuestas.length == 0">
                                        <div class="bg-blue-50 border border-blue-400 text-blue-800 p-4">
                                            <p class="font-semibold">Información</p>
                                            <p>La última atención realizada al paciente no fue la encuesta S.R.Q. Si
                                                deseas ver el último resultado S.R.Q, ve a expedientes y realiza una
                                                búsqueda con el DNI.</p>
                                        </div>

                                    </div>
                                    <!-- Detalles -->
                                    <div *ngIf="!isLoading && respuestas.length > 0">
                                        <div class="p-2 flex items-center justify-between"
                                            style="background-color: #1075bc;">
                                            <h2 class="text-sm text-white font-bold">DETALLES</h2>
                                            <!-- <button class=" bg-gray-400 text-white rounded hover:bg-gray-500 transition"
                                            title="Marcar como revisado" (click)="marcarComoRevisado()">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                stroke-width="1.5" stroke="currentColor" class="size-6">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                            </svg>
                                        </button> -->
                                        </div>

                                        <!-- Información del detalle -->
                                        <div class="border p-4">
                                            <div *ngIf="showFullDetails; else infoOnly"
                                                class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Columna 1: Detalles del Estudiante -->
                                                <div class="bg-gray-200 border border-gray-300 rounded-lg p-4 h-24">
                                                    <p class="text-sm text-gray-700">
                                                        El estudiante ha marcado
                                                        <span class="font-bold text-green-500">{{ totalSi }}</span>
                                                        respuestas "Sí" y
                                                        <span class="font-bold text-red-500">{{ totalNo }}</span>
                                                        respuestas
                                                        "No". Según los resultados, el diagnóstico es:
                                                        <span class="font-bold" [ngClass]="diagnosticoClass">{{
                                                            diagnostico
                                                            }}</span>.
                                                    </p>
                                                </div>

                                                <!-- Columna 2: Acciones -->
                                                <div>
                                                    <textarea id="studentMessage" [(ngModel)]="studentMessage"
                                                        name="studentMessage"
                                                        class="w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none mb-2"
                                                        placeholder="Escribe un nota para completar la revisión"
                                                        rows="3"></textarea>

                                                    <!-- Radio Buttons -->
                                                    <div class="mb-4">
                                                        <div class="flex items-center mb-2">
                                                            <input id="markAsObserved" type="radio"
                                                                [(ngModel)]="selectedAction" name="action"
                                                                value="observed"
                                                                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500" />
                                                            <label for="markAsObserved"
                                                                class="ml-2 text-sm text-gray-700">
                                                                Marcar como observado
                                                            </label>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <input id="approveResult" type="radio"
                                                                [(ngModel)]="selectedAction" name="action"
                                                                value="approved"
                                                                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-2 focus:ring-blue-500" />
                                                            <label for="approveResult"
                                                                class="ml-2 text-sm text-gray-700">
                                                                Aprobar resultados
                                                            </label>
                                                        </div>
                                                        <p class="text-xs text-gray-500 mt-2">
                                                            Si selecciona una opción sin mensaje, el botón permitirá
                                                            guardar. Si agrega un mensaje, se enviará por WhatsApp.
                                                        </p>
                                                    </div>

                                                    <!-- Botón Dinámico -->
                                                    <button type="button" (click)="handleAction()"
                                                        [disabled]="!selectedAction"
                                                        style="background-color: #1075bc;"
                                                        class="w-full text-white  px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                                                        {{ getButtonText() }}
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Plantilla Alternativa -->
                                            <ng-template #infoOnly>
                                                <div class="grid grid-cols-1 gap-4">
                                                    <!-- Columna 1: Detalles del Estudiante -->
                                                    <div class="bg-gray-200 border border-gray-300 rounded-lg p-4">
                                                        <p class="text-sm text-gray-700">
                                                            El estudiante ha marcado
                                                            <span class="font-bold text-green-500">{{ totalSi }}</span>
                                                            respuestas "Sí" y
                                                            <span class="font-bold text-red-500">{{ totalNo }}</span>
                                                            respuestas
                                                            "No". Según los resultados, el diagnóstico es:
                                                            <span class="font-bold" [ngClass]="diagnosticoClass">{{
                                                                diagnostico }}</span>.
                                                        </p>
                                                    </div>
                                                </div>
                                            </ng-template>

                                        </div>
                                    </div>



                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="button" (click)="closeModal()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </ng-template>
</div>